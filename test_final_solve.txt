============================= test session starts ==============================
platform linux -- Python 3.11.2, pytest-8.4.2, pluggy-1.6.0 -- /home/sverzijl/planning_latest/venv/bin/python
cachedir: .pytest_cache
rootdir: /home/sverzijl/planning_latest
plugins: cov-7.0.0, mock-3.15.1
collecting ... collected 1 item

tests/test_validation_integration.py::test_sliding_window_with_validated_data 
================================================================================
TEST: SLIDING WINDOW MODEL WITH VALIDATED DATA
================================================================================

1. Loading and validating data...
✓ Data validated successfully

Validated Planning Data Summary:
  Products: 5
  Nodes: 11
  Demand entries: 1305 (346,687 units total)
  Inventory entries: 49 (49,581 units total)
  Planning horizon: 2025-11-03 to 2025-12-01 (29 days)
  Inventory snapshot: 2025-11-03
  Data source: Gluten Free Forecast - Latest.xlsm, Network_Config.xlsx
  Loaded at: 2025-11-03 02:01:31.886138


2. Creating model...
   Loading network components via MultiFileParser...

Preprocessing initial inventory:
  Input keys sample: [('6104', 'HELGAS GFREE TRAD WHITE 470G', 'ambient'), ('6110', 'HELGAS GFREE TRAD WHITE 470G', 'ambient'), ('6122', 'HELGAS GFREE TRAD WHITE 470G', 'ambient')]
  Input entry count: 34
  Initial inventory: 34 entries
  Converted keys sample: [('6104', 'HELGAS GFREE TRAD WHITE 470G', 'ambient'), ('6110', 'HELGAS GFREE TRAD WHITE 470G', 'ambient'), ('6122', 'HELGAS GFREE TRAD WHITE 470G', 'ambient')]
  Converted entry count: 34
  Total quantity: 30,823 units

Validating initial inventory against node capabilities:
  ✓ All 34 entries have compatible states and products
  Manufacturing nodes: 1
  Demand nodes: 9
  Routes FROM Lineage: 1
    - Lineage → 6130 (mode=frozen, days=7.0)
  Routes TO Lineage: 1
    - 6122 → Lineage (mode=ambient, days=1.0)

Sliding Window Model Initialized:
  Nodes: 11
  Routes: 10
  Products: 5
  Planning horizon: 29 days
  Demand entries: 1305
  Pallet tracking: True
✓ Model built in 0.02s

3. Solving model...
Building Pyomo model in solve()...

================================================================================
BUILDING SLIDING WINDOW MODEL [git:1235c97]
================================================================================

Sets defined:
  Nodes: 11
  Products: 5
  Dates: 29
  States: 3

Adding variables...
  Production variables: 145
  Inventory variables: 3045
  Checking inventory variables for initial_inventory entries:
    ('6104', 'HELGAS GFREE TRAD WHITE 470G', 'ambient', datetime.date(2025, 11, 3)): exists=True, qty=2397
    ('6110', 'HELGAS GFREE TRAD WHITE 470G', 'ambient', datetime.date(2025, 11, 3)): exists=True, qty=285
    ('6122', 'HELGAS GFREE TRAD WHITE 470G', 'ambient', datetime.date(2025, 11, 3)): exists=True, qty=1280
    ('6123', 'HELGAS GFREE TRAD WHITE 470G', 'ambient', datetime.date(2025, 11, 3)): exists=True, qty=609
    ('6125', 'HELGAS GFREE TRAD WHITE 470G', 'ambient', datetime.date(2025, 11, 3)): exists=True, qty=3225
  State transition variables: 0 thaw + 0 freeze
  In-transit variables: 2900 (indexed by DEPARTURE date)
  Pallet storage variables: 1595 integers
  Pallet entry variables: 1595 integers (for fixed costs)
  Truck pallet variables: 1595 integers
  Demand consumed variables: 1305
  Shortage variables: 1305
  Disposal variables: 408 (only for expired inventory)
  Disposal for 34 inventory items
  Binary product indicators: 290
  Labor variables: 29 (hours + overtime)
  Mix count variables: 145 integers

Variables created
  Continuous: 6,090
  Integers: 1,595
  Binaries: 290
  TOTAL: 7,975
  (vs cohort model: ~500,000 total)

Adding constraints...

  Adding sliding window shelf life constraints...
  DAY2 ambient_shelf_life[6122, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 1280.0 + production['6122',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + production['6122',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
    O: in_transit['6122','6104',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6122','6110',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6122','6125',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6122',Lineage,HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6122','6104',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6122','6110',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6122','6125',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6122',Lineage,HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient]
  DAY 18 ambient_shelf_life[6122, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6122, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 1280.0 + production['6122',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + production['6122',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
    O: in_transit['6122','6104',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6122','6110',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6122','6125',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6122',Lineage,HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6122','6104',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6122','6110',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6122','6125',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6122',Lineage,HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient]
  DAY 18 ambient_shelf_life[6122, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6122, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 1600.0 + production['6122',HELGAS GFREE WHOLEM 500G,2025-11-03] + production['6122',HELGAS GFREE WHOLEM 500G,2025-11-04]
    O: in_transit['6122','6104',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6110',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6125',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122',Lineage,HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6104',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122','6110',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122','6125',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122',Lineage,HELGAS GFREE WHOLEM 500G,2025-11-04,ambient]
  DAY 18 ambient_shelf_life[6122, HELGAS GFREE WHOLEM 500G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6122, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 1280.0 + production['6122',WONDER GFREE WHITE 470G,2025-11-03] + production['6122',WONDER GFREE WHITE 470G,2025-11-04]
    O: in_transit['6122','6104',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6122','6110',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6122','6125',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6122',Lineage,WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6122','6104',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6122','6110',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6122','6125',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6122',Lineage,WONDER GFREE WHITE 470G,2025-11-04,ambient]
  DAY 18 ambient_shelf_life[6122, WONDER GFREE WHITE 470G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6122, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 960.0 + production['6122',WONDER GFREE WHOLEM 500G,2025-11-03] + production['6122',WONDER GFREE WHOLEM 500G,2025-11-04]
    O: in_transit['6122','6104',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6110',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6125',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122',Lineage,WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6122','6104',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122','6110',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122','6125',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6122',Lineage,WONDER GFREE WHOLEM 500G,2025-11-04,ambient]
  DAY2 ambient_shelf_life[6104, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 676.0 + in_transit['6122','6104',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient]
    O: in_transit['6104','6105',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6104','6103',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + demand_consumed['6104',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + in_transit['6104','6105',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6104','6103',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + demand_consumed['6104',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6104, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 2397.0 + in_transit['6122','6104',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient]
    O: in_transit['6104','6105',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6104','6103',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + demand_consumed['6104',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + in_transit['6104','6105',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6104','6103',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + demand_consumed['6104',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY 18 ambient_shelf_life[6104, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6104, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 904.0 + in_transit['6122','6104',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient]
    O: in_transit['6104','6105',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6104','6103',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + demand_consumed['6104',HELGAS GFREE WHOLEM 500G,2025-11-03] + in_transit['6104','6105',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6104','6103',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + demand_consumed['6104',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6104, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 957.0 + in_transit['6122','6104',WONDER GFREE WHITE 470G,2025-11-03,ambient]
    O: in_transit['6104','6105',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6104','6103',WONDER GFREE WHITE 470G,2025-11-03,ambient] + demand_consumed['6104',WONDER GFREE WHITE 470G,2025-11-03] + in_transit['6104','6105',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6104','6103',WONDER GFREE WHITE 470G,2025-11-04,ambient] + demand_consumed['6104',WONDER GFREE WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6104, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 549.0 + in_transit['6122','6104',WONDER GFREE WHOLEM 500G,2025-11-03,ambient]
    O: in_transit['6104','6105',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6104','6103',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + demand_consumed['6104',WONDER GFREE WHOLEM 500G,2025-11-03] + in_transit['6104','6105',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6104','6103',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + demand_consumed['6104',WONDER GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6125, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 655.0 + in_transit['6122','6125',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient]
    O: in_transit['6125','6123',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6125','6134',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + in_transit['6125','6120',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient] + demand_consumed['6125',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + in_transit['6125','6123',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6125','6134',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + in_transit['6125','6120',HELGAS GFREE MIXED GRAIN 500G,2025-11-04,ambient] + demand_consumed['6125',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6125, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 3225.0 + in_transit['6122','6125',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient]
    O: in_transit['6125','6123',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6125','6134',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + in_transit['6125','6120',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient] + demand_consumed['6125',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + in_transit['6125','6123',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6125','6134',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + in_transit['6125','6120',HELGAS GFREE TRAD WHITE 470G,2025-11-04,ambient] + demand_consumed['6125',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY 18 ambient_shelf_life[6125, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6125, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 3267.0 + in_transit['6122','6125',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient]
    O: in_transit['6125','6123',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6125','6134',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6125','6120',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient] + demand_consumed['6125',HELGAS GFREE WHOLEM 500G,2025-11-03] + in_transit['6125','6123',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6125','6134',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6125','6120',HELGAS GFREE WHOLEM 500G,2025-11-04,ambient] + demand_consumed['6125',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY 18 ambient_shelf_life[6125, HELGAS GFREE WHOLEM 500G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6125, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 5416.0 + in_transit['6122','6125',WONDER GFREE WHITE 470G,2025-11-03,ambient]
    O: in_transit['6125','6123',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6125','6134',WONDER GFREE WHITE 470G,2025-11-03,ambient] + in_transit['6125','6120',WONDER GFREE WHITE 470G,2025-11-03,ambient] + demand_consumed['6125',WONDER GFREE WHITE 470G,2025-11-03] + in_transit['6125','6123',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6125','6134',WONDER GFREE WHITE 470G,2025-11-04,ambient] + in_transit['6125','6120',WONDER GFREE WHITE 470G,2025-11-04,ambient] + demand_consumed['6125',WONDER GFREE WHITE 470G,2025-11-04]
  DAY 18 ambient_shelf_life[6125, WONDER GFREE WHITE 470G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6125, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 1474.0 + in_transit['6122','6125',WONDER GFREE WHOLEM 500G,2025-11-03,ambient]
    O: in_transit['6125','6123',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6125','6134',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + in_transit['6125','6120',WONDER GFREE WHOLEM 500G,2025-11-03,ambient] + demand_consumed['6125',WONDER GFREE WHOLEM 500G,2025-11-03] + in_transit['6125','6123',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6125','6134',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + in_transit['6125','6120',WONDER GFREE WHOLEM 500G,2025-11-04,ambient] + demand_consumed['6125',WONDER GFREE WHOLEM 500G,2025-11-04]
  DAY 18 ambient_shelf_life[6125, WONDER GFREE WHOLEM 500G]:
    Window: 2025-11-04 to 2025-11-20 (17 days)
    days_from_start: 17
    Condition (<=16): False
    Init_inv in Q: NO
  DAY2 ambient_shelf_life[6123, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 595.0 + in_transit['6125','6123',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient]
    O: demand_consumed['6123',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + demand_consumed['6123',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6123, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 609.0 + in_transit['6125','6123',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient]
    O: demand_consumed['6123',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + demand_consumed['6123',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6123, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 704.0 + in_transit['6125','6123',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient]
    O: demand_consumed['6123',HELGAS GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6123',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6123, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 404.0 + in_transit['6125','6123',WONDER GFREE WHITE 470G,2025-11-03,ambient]
    O: demand_consumed['6123',WONDER GFREE WHITE 470G,2025-11-03] + demand_consumed['6123',WONDER GFREE WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6123, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 327.0 + in_transit['6125','6123',WONDER GFREE WHOLEM 500G,2025-11-03,ambient]
    O: demand_consumed['6123',WONDER GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6123',WONDER GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6120, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 6.0 + in_transit['6125','6120',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,ambient]
    O: demand_consumed['6120',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + demand_consumed['6120',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6120, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 6.0 + in_transit['6125','6120',HELGAS GFREE TRAD WHITE 470G,2025-11-03,ambient]
    O: demand_consumed['6120',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + demand_consumed['6120',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6120, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 1.0 + in_transit['6125','6120',HELGAS GFREE WHOLEM 500G,2025-11-03,ambient]
    O: demand_consumed['6120',HELGAS GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6120',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6120, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 46.0 + in_transit['6125','6120',WONDER GFREE WHOLEM 500G,2025-11-03,ambient]
    O: demand_consumed['6120',WONDER GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6120',WONDER GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6110, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 259.0
    O: demand_consumed['6110',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + demand_consumed['6110',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6110, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 285.0
    O: demand_consumed['6110',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + demand_consumed['6110',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6110, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 291.0
    O: demand_consumed['6110',HELGAS GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6110',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6110, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 280.0
    O: demand_consumed['6110',WONDER GFREE WHITE 470G,2025-11-03] + demand_consumed['6110',WONDER GFREE WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6110, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 153.0
    O: demand_consumed['6110',WONDER GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6110',WONDER GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6130, HELGAS GFREE MIXED GRAIN 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 518.0
    O: demand_consumed['6130',HELGAS GFREE MIXED GRAIN 500G,2025-11-03] + demand_consumed['6130',HELGAS GFREE MIXED GRAIN 500G,2025-11-04]
  DAY2 ambient_shelf_life[6130, HELGAS GFREE TRAD WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 207.0
    O: demand_consumed['6130',HELGAS GFREE TRAD WHITE 470G,2025-11-03] + demand_consumed['6130',HELGAS GFREE TRAD WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6130, HELGAS GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 175.0
    O: demand_consumed['6130',HELGAS GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6130',HELGAS GFREE WHOLEM 500G,2025-11-04]
  DAY2 ambient_shelf_life[6130, WONDER GFREE WHITE 470G]:
    Window: 2 days
    Q (should NOT include init_inv): 34.0
    O: demand_consumed['6130',WONDER GFREE WHITE 470G,2025-11-03] + demand_consumed['6130',WONDER GFREE WHITE 470G,2025-11-04]
  DAY2 ambient_shelf_life[6130, WONDER GFREE WHOLEM 500G]:
    Window: 2 days
    Q (should NOT include init_inv): 3.0
    O: demand_consumed['6130',WONDER GFREE WHOLEM 500G,2025-11-03] + demand_consumed['6130',WONDER GFREE WHOLEM 500G,2025-11-04]
    Q_frozen (inflows): 0
    O_frozen (outflows): in_transit[Lineage,'6130',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,frozen]
    Shelf life bound: inventory <= Q-O
    Q_frozen (inflows): 0
    O_frozen (outflows): in_transit[Lineage,'6130',HELGAS GFREE TRAD WHITE 470G,2025-11-03,frozen]
    Shelf life bound: inventory <= Q-O
    Q_frozen (inflows): 0
    O_frozen (outflows): in_transit[Lineage,'6130',HELGAS GFREE WHOLEM 500G,2025-11-03,frozen]
    Shelf life bound: inventory <= Q-O
    Q_frozen (inflows): 0
    O_frozen (outflows): in_transit[Lineage,'6130',WONDER GFREE WHITE 470G,2025-11-03,frozen]
    Shelf life bound: inventory <= Q-O
    Q_frozen (inflows): 0
    O_frozen (outflows): in_transit[Lineage,'6130',WONDER GFREE WHOLEM 500G,2025-11-03,frozen]
    Shelf life bound: inventory <= Q-O
  Shelf life window constraints: 3,045
    Ambient (17d): ~1,450
    Frozen (120d): ~145
    Thawed (14d): ~1,450

  Adding state balance constraints...
  DEBUG arrivals for 6104, HELGAS GFREE MIXED GRAIN 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6104, HELGAS GFREE TRAD WHITE 470G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6104, HELGAS GFREE WHOLEM 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6104, WONDER GFREE WHITE 470G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6104, WONDER GFREE WHOLEM 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6125, HELGAS GFREE MIXED GRAIN 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6125, HELGAS GFREE TRAD WHITE 470G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6125, HELGAS GFREE WHOLEM 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6125, WONDER GFREE WHITE 470G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG arrivals for 6125, WONDER GFREE WHOLEM 500G, 2025-11-04:
    Route from 6122, transit=1.0
    Departure date: 2025-11-03
    departure_date in model.dates: True
    Key in model.in_transit: True
    Arrival state: ambient
  DEBUG frozen_balance[Lineage, HELGAS GFREE MIXED GRAIN 500G, 2025-11-03]:
    prev_inv: 0
    production_inflow: 0
    freeze_inflow: 0
    arrivals: 0
    thaw_outflow: 0
    departures: in_transit[Lineage,'6130',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,frozen]
    in_transit[('Lineage', '6130', 'HELGAS GFREE MIXED GRAIN 500G', datetime.date(2025, 11, 3), 'frozen')] exists: True
    Expected: inventory = 0 + 0 + 0 + arrivals - departures - 0
  DEBUG frozen_balance[Lineage, HELGAS GFREE TRAD WHITE 470G, 2025-11-03]:
    prev_inv: 0
    production_inflow: 0
    freeze_inflow: 0
    arrivals: 0
    thaw_outflow: 0
    departures: in_transit[Lineage,'6130',HELGAS GFREE TRAD WHITE 470G,2025-11-03,frozen]
    in_transit[('Lineage', '6130', 'HELGAS GFREE TRAD WHITE 470G', datetime.date(2025, 11, 3), 'frozen')] exists: True
    Expected: inventory = 0 + 0 + 0 + arrivals - departures - 0
  DEBUG frozen_balance[Lineage, HELGAS GFREE WHOLEM 500G, 2025-11-03]:
    prev_inv: 0
    production_inflow: 0
    freeze_inflow: 0
    arrivals: 0
    thaw_outflow: 0
    departures: in_transit[Lineage,'6130',HELGAS GFREE WHOLEM 500G,2025-11-03,frozen]
    in_transit[('Lineage', '6130', 'HELGAS GFREE WHOLEM 500G', datetime.date(2025, 11, 3), 'frozen')] exists: True
    Expected: inventory = 0 + 0 + 0 + arrivals - departures - 0
  DEBUG frozen_balance[Lineage, WONDER GFREE WHITE 470G, 2025-11-03]:
    prev_inv: 0
    production_inflow: 0
    freeze_inflow: 0
    arrivals: 0
    thaw_outflow: 0
    departures: in_transit[Lineage,'6130',WONDER GFREE WHITE 470G,2025-11-03,frozen]
    in_transit[('Lineage', '6130', 'WONDER GFREE WHITE 470G', datetime.date(2025, 11, 3), 'frozen')] exists: True
    Expected: inventory = 0 + 0 + 0 + arrivals - departures - 0
  DEBUG frozen_balance[Lineage, WONDER GFREE WHOLEM 500G, 2025-11-03]:
    prev_inv: 0
    production_inflow: 0
    freeze_inflow: 0
    arrivals: 0
    thaw_outflow: 0
    departures: in_transit[Lineage,'6130',WONDER GFREE WHOLEM 500G,2025-11-03,frozen]
    in_transit[('Lineage', '6130', 'WONDER GFREE WHOLEM 500G', datetime.date(2025, 11, 3), 'frozen')] exists: True
    Expected: inventory = 0 + 0 + 0 + arrivals - departures - 0
  DEBUG thawed_balance[6130, HELGAS GFREE MIXED GRAIN 500G, 2025-11-03]:
    prev_inv: 0
    thaw_inflow: 0
    arrivals: 0
    Expected: inventory = 0 + thaw + arrivals - departures - demand
  DEBUG thawed_balance[6130, HELGAS GFREE MIXED GRAIN 500G, 2025-11-10]:
    prev_inv: inventory['6130',HELGAS GFREE MIXED GRAIN 500G,thawed,2025-11-09]
    thaw_inflow: 0
    arrivals: in_transit[Lineage,'6130',HELGAS GFREE MIXED GRAIN 500G,2025-11-03,frozen]
    Expected: inventory = inventory['6130',HELGAS GFREE MIXED GRAIN 500G,thawed,2025-11-09] + thaw + arrivals - departures - demand
  State balance constraints: 3,045

  Adding demand satisfaction...
  Demand balance constraints: 1305

  Adding pallet constraints...
    Storage pallet ceiling constraints added
    Pallet entry detection constraints added
    Truck pallet ceiling constraints added: 1525

  Adding production constraints...
    Mix-based production constraints added
    Production capacity constraints added
    Overtime detection constraints added

  Adding changeover detection...
    Changeover detection constraints added

  Adding truck constraints...
    Truck capacity constraints added: 319

Constraints added

Building objective...
  Production cost: $1.30/unit
  Frozen pallet fixed cost: $14.2600/pallet (on entry)
  Frozen pallet daily cost: $0.9800/pallet/day
  Shortage penalty: $10.00/unit
  Disposal penalty: $15.00/unit (> shortage $10.00/unit)
  Labor cost: Weekday overtime ($660/h) + Weekend ($1320/h), fixed hours FREE
  Changeover cost: $38.40 per start
  Changeover waste: 30 units per start × $1.30/unit = $39.00 per start
  Waste cost: $13.00/unit × (end_inventory + end_in_transit)

Objective built
  Active components: production + labor + transport + holding + shortage + disposal + changeover (cost + waste) + waste
  Staleness: IMPLICIT via holding costs (inventory costs money)

Model built successfully
  Writing model to workflow_model_debug.lp...
  Model written successfully

APPSI Solver Results:
  termination_condition: TerminationCondition.optimal
  best_feasible_objective: 3833219.90978
  best_objective_bound: 3833219.90978
  -> Solver reports OPTIMAL
  -> Solution loaded successfully

Mapping APPSI result to legacy format:
  APPSI termination: TerminationCondition.optimal
  -> Mapped to: optimal, success=True

✓ SOLVE COMPLETE:
   Status: optimal
   Solve time: 1.8s
   Objective: $3,833,219.91
FAILED

=================================== FAILURES ===================================
___________________ test_sliding_window_with_validated_data ____________________

data_files = {'forecast': PosixPath('data/examples/Gluten Free Forecast - Latest.xlsm'), 'inventory': PosixPath('data/examples/inventory_latest.XLSX'), 'network': PosixPath('data/examples/Network_Config.xlsx')}

    def test_sliding_window_with_validated_data(data_files):
        """Test sliding window model with validated data - should produce > 0."""
    
        from src.optimization.sliding_window_model import SlidingWindowModel
        from src.models.product import Product
    
        print("\n" + "="*80)
        print("TEST: SLIDING WINDOW MODEL WITH VALIDATED DATA")
        print("="*80)
    
        # Load and validate data
        print("\n1. Loading and validating data...")
        validated_data = load_validated_data(
            forecast_file=data_files['forecast'],
            network_file=data_files['network'],
            inventory_file=data_files['inventory'],
            planning_weeks=4
        )
    
        print(f"✓ Data validated successfully")
        print(validated_data.summary())
    
        # Convert to model format
        print("\n2. Creating model...")
    
        # Convert ValidatedPlanningData products to Product objects
        products_dict = {}
        for prod in validated_data.products:
            products_dict[prod.id] = Product(
                id=prod.id,
                sku=prod.sku or prod.id,
                name=prod.name,
                units_per_mix=415  # Default
            )
    
        # Create forecast from validated demand (needed before conversion)
        from src.models.forecast import Forecast, ForecastEntry
        forecast_entries = [
            ForecastEntry(
                location_id=entry.node_id,
                product_id=entry.product_id,
                forecast_date=entry.demand_date,
                quantity=entry.quantity
            )
            for entry in validated_data.demand_entries
        ]
        forecast = Forecast(name="Validated Forecast", entries=forecast_entries)
    
        # Load network components using MultiFileParser (handles all format conversions)
        # This is the exact pattern from the working test - reuse proven infrastructure
        print("   Loading network components via MultiFileParser...")
        from src.parsers.multi_file_parser import MultiFileParser
    
        parser = MultiFileParser(
            forecast_file=data_files['forecast'],
            network_file=data_files['network'],
            inventory_file=data_files['inventory']
        )
    
        # Parse all components
        _, locations, routes_legacy, labor_calendar, truck_schedules_list, cost_structure = parser.parse_all()
    
        # Get manufacturing site
        from src.models.manufacturing import ManufacturingSite
        from src.models.location import LocationType
    
        manufacturing_locations = [loc for loc in locations if loc.type == LocationType.MANUFACTURING]
        if not manufacturing_locations:
            raise ValueError("No manufacturing site found")
    
        manufacturing_site = manufacturing_locations[0]
    
        # Convert to unified format (exact pattern from working test)
        from src.optimization.legacy_to_unified_converter import LegacyToUnifiedConverter
    
        converter = LegacyToUnifiedConverter()
        nodes = converter.convert_nodes(manufacturing_site, locations, forecast)
        unified_routes = converter.convert_routes(routes_legacy)
        unified_truck_schedules = converter.convert_truck_schedules(truck_schedules_list, manufacturing_site.id)
    
        # Build model
        model_start = time.time()
    
        model = SlidingWindowModel(
            nodes=nodes,  # Pass as list, model will convert to dict internally
            routes=unified_routes,  # Use converted unified routes
            forecast=forecast,
            products=products_dict,
            labor_calendar=labor_calendar,
            cost_structure=cost_structure,
            start_date=validated_data.planning_start_date,
            end_date=validated_data.planning_end_date,
            truck_schedules=unified_truck_schedules,  # Use converted unified truck schedules
            initial_inventory=validated_data.get_inventory_dict(),  # VALIDATED!
            inventory_snapshot_date=validated_data.inventory_snapshot_date,
            allow_shortages=True,
            use_pallet_tracking=True,
            use_truck_pallet_tracking=True
        )
    
        model_build_time = time.time() - model_start
        print(f"✓ Model built in {model_build_time:.2f}s")
    
        # Solve
        print("\n3. Solving model...")
        solve_start = time.time()
    
        result = model.solve(
            solver_name='appsi_highs',
            time_limit_seconds=120,
            mip_gap=0.02,
            use_aggressive_heuristics=False,
            tee=False
        )
    
        solve_time = time.time() - solve_start
    
        print(f"\n✓ SOLVE COMPLETE:")
        print(f"   Status: {result.termination_condition}")
        print(f"   Solve time: {solve_time:.1f}s")
        print(f"   Objective: ${result.objective_value:,.2f}")
    
        # Extract solution metrics
>       total_production = result.total_production
                           ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'OptimizationResult' object has no attribute 'total_production'

tests/test_validation_integration.py:201: AttributeError
------------------------------ Captured log call -------------------------------
WARNING  src.validation.data_coordinator:data_coordinator.py:179 Products sheet not found: 
======================================================================
MISSING PRODUCTS SHEET
======================================================================

The Excel file 'Gluten Free Forecast - Latest.xlsm' does not contain a 'Products' sheet.

REQUIRED ACTION:
  1. Open your Excel file: data/examples/Gluten Free Forecast - Latest.xlsm
  2. Create a new sheet named 'Products'
  3. Add the following columns:
     - product_id (string, required)
     - name (string, required)
     - sku (string, required)
     - shelf_life_ambient_days (float, default: 17)
     - shelf_life_frozen_days (float, default: 120)
     - shelf_life_after_thaw_days (float, default: 14)
     - min_acceptable_shelf_life_days (float, default: 7)
     - units_per_mix (integer, required, must be > 0)

EXAMPLE:
  product_id | name      | sku   | ... | units_per_mix
  -----------|-----------|-------|-----|---------------
  G144       | Product A | G144  | ... | 415
  G145       | Product B | G145  | ... | 387

DOCUMENTATION:
  - See: data/examples/EXCEL_TEMPLATE_SPEC.md
  - Example: data/examples/Network_Config.xlsx

======================================================================
. Creating minimal Product objects from forecast.
WARNING  pyomo.core:block.py:1992 Filename 'workflow_model_debug.lp' likely does not match specified file format (lp)
WARNING  src.optimization.sliding_window_model:sliding_window_model.py:2007 NO PRODUCTION EXTRACTED! Check if model.production variable exists and has values.
=============================== warnings summary ===============================
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
  /home/sverzijl/planning_latest/venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/test_validation_integration.py::test_sliding_window_with_validated_data
  /home/sverzijl/planning_latest/src/parsers/inventory_parser.py:167: UserWarning: Found 8 negative quantity values. These were set to 0.
    warnings.warn(

tests/test_validation_integration.py::test_sliding_window_with_validated_data
  /home/sverzijl/planning_latest/src/parsers/inventory_parser.py:173: UserWarning: Skipped 39 entries with Storage Location 5000 (excluded from inventory).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_validation_integration.py::test_sliding_window_with_validated_data
======================== 1 failed, 10 warnings in 5.25s ========================
