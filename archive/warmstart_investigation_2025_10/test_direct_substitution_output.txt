/home/sverzijl/planning_latest/src/parsers/inventory_parser.py:167: UserWarning: Found 5 negative quantity values. These were set to 0.
  warnings.warn(
/home/sverzijl/planning_latest/src/optimization/unified_node_model.py:287: UserWarning: Zero cost parameters detected: All route transport costs are 0, ambient storage costs are 0. This may cause solver to leave some variables uninitialized (valid behavior). Consider using small non-zero costs (e.g., 0.0001) if you encounter solution extraction issues.
  warnings.warn(warning_msg, UserWarning)
================================================================================
TEST: Direct Substitution Solvability Check
================================================================================

Question: Can we eliminate counting constraint using direct substitution?
Formulation: overhead = (S+S-C)*production_day + C*sum(product_produced)


================================================================================
BUILD MODEL WITH DIRECT SUBSTITUTION
================================================================================

üì¶ Preprocessed initial inventory: 23 items, prod_date=2025-10-21 (one day before snapshot)

Unified Model Data Summary:
  Nodes: 11
    Manufacturing: 1
    Demand: 9
    With truck constraints: 1
  Routes: 10
  Truck schedules: 11
  Planning horizon: 2025-10-20 to 2025-11-16 (28 days)
  Products: 5
  Demand entries: 1260

Building model with direct substitution...

Building Unified Node Model...
  Sets defined: 11 nodes, 5 products, 28 dates, 10 routes
  Production dates for cohorts: 28 in horizon + 0 from initial inventory
  Cohort indices: 17,780 cohorts
  Shipment cohorts by origin node:
    6104: 3780
    6122: 7425
    6125: 5670
    Lineage: 1155
  Shipment cohort indices: 18,030
  Demand cohort indices: 14,175
  Changeover tracking: 28 production days, 140 product indicators (VARIABLE (binary decision))
  Labor cost variables: 28 labor hour variables added
  Variables created successfully
  Adding core constraints...
  Changeover tracking constraints added (224 constraints)
  Big-M value for product_produced linking: 19,600 units/day
  Labor cost constraints added (28 node-date pairs, 252 constraints)
  Adding storage shipment delay constraint for 3 nodes: ['6104', '6125', 'Lineage']
    Added 75 storage delay constraints
  Hybrid pallet formulation (MIP optimization):
    Small cohorts (integer 0-10): 2,030
    Domain reduced: 62 ‚Üí 10 (84% reduction)
  Pallet tracking enabled for states: ['frozen']
    - Pallet integer variables: 2,030
    - Domain per variable: 0-10 (vs 0-62 full formulation)
    - Unit-tracked states: ['ambient', 'thawed']
  Holding cost enabled: 17,780 total cohorts (5,926 pallet-tracked)

  Staleness penalty enabled: $0.0500 per unit per day of age
  Staleness penalty calculation: 14,175 demand cohorts
  Formula: min(age_days, 17) √ó $0.0500 √ó demand_satisfied
  Core constraints added
  Truck constraints added (generalized for any node)
  Model complete and ready to solve

Model built. Now removing counting constraint and using direct substitution...
  ‚úì  Deactivated counting constraint
  ‚úì  Deactivated original labor_hours_linking_con
  ‚úì  Deactivated original production_capacity_con

  Reformulating with direct substitution...
  ‚úì  Added 56 reformulated constraints

‚úÖ Direct substitution formulation complete!

================================================================================
MODEL STRUCTURE VERIFICATION
================================================================================

Variable counts:
  Binary:     504
  Integer:    2,058
  Continuous: 53,177
  Total:      55,739

Active constraints: 36,891
  Counting constraints active: 0 (should be 0)

================================================================================
SOLVABILITY TEST
================================================================================

Solving model with direct substitution...
Expected: Should solve successfully (no counting constraint issues)

Running HiGHS 1.11.0 (git hash: 364c83a): Copyright (c) 2025 HiGHS under MIT licence terms
MIP  has 36891 rows; 55739 cols; 166887 nonzeros; 2562 integer variables (504 binary)
Coefficient ranges:
  Matrix [1e-04, 2e+04]
  Cost   [5e-02, 1e+03]
  Bound  [1e+00, 2e+04]
  RHS    [1e-02, 2e+04]
Presolving model
29036 rows, 43497 cols, 135110 nonzeros  0s
22532 rows, 33186 cols, 105881 nonzeros  0s
16817 rows, 30136 cols, 90676 nonzeros  0s

Solving MIP model with:
   16817 rows
   30136 cols (168 binary, 910 integer, 0 implied int., 29058 continuous, 0 domain fixed)
   90676 nonzeros

Src: B => Branching; C => Central rounding; F => Feasibility pump; J => Feasibility jump;
     H => Heuristic; L => Sub-MIP; P => Empty MIP; R => Randomized rounding; Z => ZI Round;
     I => Shifting; S => Solve LP; T => Evaluate node; U => Unbounded; X => User solution;
     z => Trivial zero; l => Trivial lower; u => Trivial upper; p => Trivial point

        Nodes      |    B&B Tree     |            Objective Bounds              |  Dynamic Constraints |       Work      
Src  Proc. InQueue |  Leaves   Expl. | BestBound       BestSol              Gap |   Cuts   InLp Confl. | LpIters     Time

 J       0       0         0   0.00%   -inf            3376253.95125      Large        0      0      0         0     1.3s
         0       0         0   0.00%   783939.932862   3376253.95125     76.78%        0      0      6     19867     5.4s
         0       0         0   0.00%   785066.291985   3376253.95125     76.75%     4088    124      6     25020    12.6s
         0       0         0   0.00%   785236.231776   3376253.95125     76.74%     5522    197      6     39367    29.8s
         0       0         0   0.00%   786248.473367   3376253.95125     76.71%     7301    270      6     54250    44.5s
         0       0         0   0.00%   787756.623556   3376253.95125     76.67%     8714    335     74     58843    54.8s
         0       0         0   0.00%   788465.732976   3376253.95125     76.65%     9967    393     74     67219    61.8s
         0       0         0   0.00%   789350.928757   3376253.95125     76.62%     8563    497     74     72197    67.9s
         0       0         0   0.00%   790025.674946   3376253.95125     76.60%    10369    601     74     78271    75.7s
         0       0         0   0.00%   790465.186669   3376253.95125     76.59%    10015    695     74     81396    80.9s
         0       0         0   0.00%   790951.617875   3376253.95125     76.57%    10126    785     74     84844    87.9s
         0       0         0   0.00%   791488.229708   3376253.95125     76.56%    10215    923     74     87252    93.0s
         0       0         0   0.00%   791889.2973     3376253.95125     76.55%    10070   1025     74     89259    98.7s
         0       0         0   0.00%   792110.83988    3376253.95125     76.54%     9734   1127     74     90711   104.0s
         0       0         0   0.00%   792280.683134   3376253.95125     76.53%    10804   1222     74     92697   111.0s
         0       0         0   0.00%   792394.076341   3376253.95125     76.53%    11533   1275     74     95042   116.5s
         0       0         0   0.00%   792426.751309   3376253.95125     76.53%    10912   1317     74     95706   120.0s

Solving report
  Status            Time limit reached
  Primal bound      3376253.95125
  Dual bound        792426.751309
  Gap               76.53% (tolerance: 3%)
  P-D integral      91.9365835114
  Solution status   feasible
                    3376253.95125 (objective)
                    0 (bound viol.)
                    0 (int. viol.)
                    0 (row viol.)
  Timing            120.02 (total)
                    0.00 (presolve)
                    0.00 (solve)
                    0.00 (postsolve)
  Max sub-MIP depth 0
  Nodes             0
  Repair LPs        0 (0 feasible; 0 iterations)
  LP iterations     95706 (total)
                    0 (strong br.)
                    75839 (separation)
                    0 (heuristics)
WARNING: Loading a feasible but suboptimal solution. Please set
load_solution=False and check results.termination_condition and
results.found_feasible_solution() before loading a solution.

================================================================================
RESULTS
================================================================================

Solve status: TerminationCondition.maxTimeLimit
Objective:    $3,376,253.95
Solve time:   124.7s

‚ùå Solver failed: TerminationCondition.maxTimeLimit
   Direct substitution may have issues
