============================= test session starts ==============================
platform linux -- Python 3.11.2, pytest-8.4.2, pluggy-1.6.0 -- /home/sverzijl/planning_latest/venv/bin/python
cachedir: .pytest_cache
rootdir: /home/sverzijl/planning_latest
plugins: cov-7.0.0, mock-3.15.1
collecting ... collected 1 item

tests/test_integration_ui_workflow.py::test_ui_workflow_4_weeks_with_initial_inventory 
⚠ No inventory file - using earliest forecast date as planning start: 2025-10-07

================================================================================
DATA SUMMARY
================================================================================
Forecast entries: 17760
Date range: 2025-10-07 to 2026-12-31
Total demand: 5,171,692 units
Locations: 11
Routes: 10
Labor days: 585
Truck schedules: 11

Planning horizon: 2025-10-07 to 2025-11-04 (4 weeks)

================================================================================
OPTIMIZATION SETTINGS
================================================================================
allow_shortages: True
enforce_shelf_life: True
use_batch_tracking: True
max_routes_per_destination: 5
mip_gap: 0.01
time_limit_seconds: 120
solver_name: cbc
start_date: 2025-10-07
end_date: 2025-11-04

================================================================================
MODEL CREATION
================================================================================
✓ Model built in 5.42s
  Routes enumerated: 8
  Planning horizon: 29 days (4.1 weeks)
  Date range: 2025-10-07 to 2025-11-04
  Batch tracking: ENABLED

================================================================================
SOLVING OPTIMIZATION
================================================================================

Building sparse cohort indices...
  Production dates: 29 in horizon + 0 from initial inventory
  Frozen cohorts: 5,820
  Ambient cohorts: 15,125
  Shipment cohorts: 19,615
  Demand cohorts: 8,660
  Freeze/thaw cohorts: 3,645
  Total: 52,865

Validating cohort model structure...
  Cohort variables: 49,220 / 21 total (234381.0%)
  ✓ Cohort model validation passed
✓ Solved in 28.20s

================================================================================
SOLUTION SUMMARY
================================================================================
Status: optimal
Objective value: $1,159,959.41
Solve time: 22.91s
Gap: 0.04%

================================================================================
COST BREAKDOWN
================================================================================
Labor cost:     $    6,001.88
Production cost: $1,032,900.00
Transport cost: $        0.00
Inventory cost: $    8,488.78
Shortage cost:  $  112,568.75
----------------------------------------
TOTAL:          $1,159,959.41

================================================================================
PRODUCTION SUMMARY
================================================================================
Total production: 206,580 units
Production batches: 76
Total labor hours: 147.6h
Average batch size: 2,718 units

================================================================================
DISTRIBUTION SUMMARY
================================================================================
Shipments created: 890
Total shipped: 334,841 units
Destinations served: 10

================================================================================
DEMAND SATISFACTION
================================================================================
Total demand (forecast): 5,171,692 units
Demand in horizon: 248,403 units
Shortage: 11,257 units
Fill rate: 95.5%

================================================================================
PERFORMANCE SUMMARY
================================================================================
Model build time: 5.42s
Solve time: 28.20s
Total time: 33.62s
Status: ✓ PASSED

================================================================================
FIRST & FINAL DAY INVENTORY CHECK
================================================================================
FIRST day (2025-10-07) inventory: 2,199 units
  By location:
    6122_Storage: 1,518 units
    Lineage: 681 units
Final planning date: 2025-11-04
Total inventory on final day: 21,608 units

Inventory by location on final day:
  Lineage: 10,374 units
  6125: 8,389 units
  6104: 2,783 units
  6122_Storage: 62 units

Demand after planning horizon (2025-11-04): 4,923,289 units
Model's knowledge of future demand: NONE (only sees 880 demand entries within horizon)

Material Balance Check:
  Production: 206,580 units
  Demand in horizon: 248,403 units
  Shortage (unmet): 11,257 units
  Satisfied demand: 237,146 units
  Final day inventory: 21,608 units
  Shipments after horizon: 0 units
  Total outflow (satisfied + final inv): 258,754 units

  Demand satisfaction validation:
    Method 1 (Forecast - Shortage): 237,146 units
    Method 2 (Cohort Consumption): 237,146 units

  Material balance (using cohort consumption):
    Production: 206,580
    Consumption + Final Inv: 258,754
    Balance: -52,174 units

⚠ MATERIAL BALANCE ISSUE (Method 1 - Forecast-based):
  Production: 206,580
  Total outflow: 258,754
  Difference: -52,174 units

❌ Material balance ALSO wrong with cohort method!
  This indicates a real flow conservation bug in the model

⚠ Model doesn't see future demand, yet holds 21,608 units
  Reason: No end-of-horizon inventory penalty in objective function

================================================================================
TEST PASSED ✓
================================================================================
PASSED

=============================== warnings summary ===============================
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
  /home/sverzijl/planning_latest/venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/test_integration_ui_workflow.py::test_ui_workflow_4_weeks_with_initial_inventory
  /home/sverzijl/planning_latest/src/optimization/integrated_model.py:781: UserWarning: 
  Planning horizon may be insufficient:
    Current start: 2025-10-07
    Required start: 2025-10-03 (4 days earlier)
    Max transit time: 3.5 days
    Early demand (on 2025-10-07) cannot be satisfied.
    Solution: Extend planning horizon or accept reduced demand satisfaction.
    warnings.warn(

tests/test_integration_ui_workflow.py::test_ui_workflow_4_weeks_with_initial_inventory
  /home/sverzijl/planning_latest/src/optimization/integrated_model.py:793: UserWarning: 
  Planning horizon end date may be insufficient:
    Current end: 2025-11-04
    Required end: 2026-12-31 (422 days later)
    Late demand (on 2026-12-31) will be filtered out.
    Solution: Extend planning horizon end date to include all demand.
    warnings.warn(

tests/test_integration_ui_workflow.py::test_ui_workflow_4_weeks_with_initial_inventory
  /home/sverzijl/planning_latest/src/optimization/integrated_model.py:830: UserWarning: Re-filtered 16880 demand entries after planning horizon adjustment. Adjusted horizon: [2025-10-07, 2025-11-04]
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================== 1 passed, 7 warnings in 39.73s ========================
