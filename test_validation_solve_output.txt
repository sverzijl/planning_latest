============================= test session starts ==============================
platform linux -- Python 3.11.2, pytest-8.4.2, pluggy-1.6.0 -- /home/sverzijl/planning_latest/venv/bin/python
cachedir: .pytest_cache
rootdir: /home/sverzijl/planning_latest
plugins: cov-7.0.0, mock-3.15.1
collecting ... collected 1 item

tests/test_validation_integration.py::test_sliding_window_with_validated_data FAILED [100%]

=================================== FAILURES ===================================
___________________ test_sliding_window_with_validated_data ____________________

data_files = {'forecast': PosixPath('data/examples/Gluten Free Forecast - Latest.xlsm'), 'inventory': PosixPath('data/examples/inventory_latest.XLSX'), 'network': PosixPath('data/examples/Network_Config.xlsx')}

    def test_sliding_window_with_validated_data(data_files):
        """Test sliding window model with validated data - should produce > 0."""
    
        from src.optimization.sliding_window_model import SlidingWindowModel
        from src.models.product import Product
    
        print("\n" + "="*80)
        print("TEST: SLIDING WINDOW MODEL WITH VALIDATED DATA")
        print("="*80)
    
        # Load and validate data
        print("\n1. Loading and validating data...")
        validated_data = load_validated_data(
            forecast_file=data_files['forecast'],
            network_file=data_files['network'],
            inventory_file=data_files['inventory'],
            planning_weeks=4
        )
    
        print(f"✓ Data validated successfully")
        print(validated_data.summary())
    
        # Convert to model format
        print("\n2. Creating model...")
    
        # Convert ValidatedPlanningData products to Product objects
        products_dict = {}
        for prod in validated_data.products:
            products_dict[prod.id] = Product(
                id=prod.id,
                sku=prod.sku or prod.id,
                name=prod.name,
                units_per_mix=415  # Default
            )
    
        # Load network components using MultiFileParser (handles all format conversions)
        # This is the exact pattern from the working test - reuse proven infrastructure
        print("   Loading network components via MultiFileParser...")
        from src.parsers.multi_file_parser import MultiFileParser
    
        parser = MultiFileParser(
            forecast_file=data_files['forecast'],
            network_file=data_files['network'],
            inventory_file=data_files['inventory']
        )
    
        # Parse all components
        _, locations, routes_legacy, labor_calendar, truck_schedules_list, cost_structure = parser.parse_all()
    
        # Get manufacturing site
        from src.models.manufacturing import ManufacturingSite
        from src.models.location import LocationType
    
        manufacturing_locations = [loc for loc in locations if loc.type == LocationType.MANUFACTURING]
        if not manufacturing_locations:
            raise ValueError("No manufacturing site found")
    
        manufacturing_site = manufacturing_locations[0]
    
        # Convert to unified format (exact pattern from working test)
        from src.optimization.legacy_to_unified_converter import LegacyToUnifiedConverter
    
        converter = LegacyToUnifiedConverter()
>       nodes = converter.convert_nodes(manufacturing_site, locations, forecast)
                                                                       ^^^^^^^^
E       UnboundLocalError: cannot access local variable 'forecast' where it is not associated with a value

tests/test_validation_integration.py:141: UnboundLocalError
----------------------------- Captured stdout call -----------------------------

================================================================================
TEST: SLIDING WINDOW MODEL WITH VALIDATED DATA
================================================================================

1. Loading and validating data...
✓ Data validated successfully

Validated Planning Data Summary:
  Products: 5
  Nodes: 11
  Demand entries: 1305 (346,687 units total)
  Inventory entries: 49 (49,581 units total)
  Planning horizon: 2025-11-03 to 2025-12-01 (29 days)
  Inventory snapshot: 2025-11-03
  Data source: Gluten Free Forecast - Latest.xlsm, Network_Config.xlsx
  Loaded at: 2025-11-03 01:59:48.187383


2. Creating model...
   Loading network components via MultiFileParser...
------------------------------ Captured log call -------------------------------
WARNING  src.validation.data_coordinator:data_coordinator.py:179 Products sheet not found: 
======================================================================
MISSING PRODUCTS SHEET
======================================================================

The Excel file 'Gluten Free Forecast - Latest.xlsm' does not contain a 'Products' sheet.

REQUIRED ACTION:
  1. Open your Excel file: data/examples/Gluten Free Forecast - Latest.xlsm
  2. Create a new sheet named 'Products'
  3. Add the following columns:
     - product_id (string, required)
     - name (string, required)
     - sku (string, required)
     - shelf_life_ambient_days (float, default: 17)
     - shelf_life_frozen_days (float, default: 120)
     - shelf_life_after_thaw_days (float, default: 14)
     - min_acceptable_shelf_life_days (float, default: 7)
     - units_per_mix (integer, required, must be > 0)

EXAMPLE:
  product_id | name      | sku   | ... | units_per_mix
  -----------|-----------|-------|-----|---------------
  G144       | Product A | G144  | ... | 415
  G145       | Product B | G145  | ... | 387

DOCUMENTATION:
  - See: data/examples/EXCEL_TEMPLATE_SPEC.md
  - Example: data/examples/Network_Config.xlsx

======================================================================
. Creating minimal Product objects from forecast.
=============================== warnings summary ===============================
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
  /home/sverzijl/planning_latest/venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/test_validation_integration.py::test_sliding_window_with_validated_data
  /home/sverzijl/planning_latest/src/parsers/inventory_parser.py:167: UserWarning: Found 8 negative quantity values. These were set to 0.
    warnings.warn(

tests/test_validation_integration.py::test_sliding_window_with_validated_data
  /home/sverzijl/planning_latest/src/parsers/inventory_parser.py:173: UserWarning: Skipped 39 entries with Storage Location 5000 (excluded from inventory).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_validation_integration.py::test_sliding_window_with_validated_data
======================== 1 failed, 10 warnings in 3.37s ========================
